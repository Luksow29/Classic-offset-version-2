import{c as E,r as t,s as w,j as e,a as A,B as S,i as L,h as q}from"./index-BQ92t-xb.js";import{I as k}from"./Input-BZEgl9G2.js";import{S as F}from"./search-CZ-s9-55.js";import{T as P}from"./trash-2-DiA01aMl.js";import{M as z}from"./Modal-BfbFXPiL.js";import{S as D}from"./Select-BwRdW-mQ.js";import{C as R}from"./Card-Cr9OAgbB.js";import{U as $}from"./user-plus-B6BSmP5E.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const I=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],B=E("pen",I);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"M12 8v4",key:"1got3b"}],["path",{d:"M12 16h.01",key:"1drbdi"}]],T=E("shield-alert",K);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Y=[["circle",{cx:"9",cy:"12",r:"3",key:"u3jwor"}],["rect",{width:"20",height:"14",x:"2",y:"5",rx:"7",key:"g7kal2"}]],V=E("toggle-left",Y);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=[["circle",{cx:"15",cy:"12",r:"3",key:"1afu0r"}],["rect",{width:"20",height:"14",x:"2",y:"5",rx:"7",key:"g7kal2"}]],H=E("toggle-right",G),J=({onEditUser:j,onDataChange:x,currentUserRole:y,currentUserId:a})=>{const[c,d]=t.useState([]),[h,l]=t.useState(!0),[u,p]=t.useState(null),[n,v]=t.useState(""),[g,f]=t.useState("created_at"),[b,M]=t.useState("desc"),N=t.useCallback(async()=>{l(!0),p(null);try{const[s,r]=await Promise.all([w.from("users").select("*").order(g,{ascending:b==="asc"}),w.from("user_status").select("user_id, status")]);if(s.error)throw s.error;if(r.error)throw r.error;const m=(r.data||[]).reduce((C,O)=>(C[O.user_id]={status:O.status},C),{}),_=(s.data||[]).map(C=>({...C,user_status:m[C.id]}));d(_)}catch(s){p(s.message)}finally{l(!1)}},[g,b]);t.useEffect(()=>{N()},[N,x]);const U=async s=>{if(y!=="Owner")return alert("Permission Denied.");if(s.id===a)return alert("You cannot delete your own account.");if(!confirm(`Are you sure you want to delete ${s.name}?`))return;l(!0);const{error:r}=await w.from("users").delete().eq("id",s.id);l(!1),r?alert("Error deleting user: "+r.message):(alert("User deleted successfully."),x())},o=async s=>{var _;if(y!=="Owner")return alert("Permission Denied.");if(s.id===a)return alert("You cannot change your own status.");const r=((_=s.user_status)==null?void 0:_.status)==="active"?"inactive":"active";l(!0);const{error:m}=await w.from("user_status").upsert({user_id:s.id,status:r},{onConflict:"user_id"});l(!1),m?alert("Error updating status: "+m.message):(alert("Status updated successfully."),x())},i=t.useMemo(()=>n?c.filter(s=>{var r,m;return((r=s.name)==null?void 0:r.toLowerCase().includes(n.toLowerCase()))||((m=s.email)==null?void 0:m.toLowerCase().includes(n.toLowerCase()))}):c,[c,n]);return h?e.jsxs("div",{children:[e.jsx(A,{className:"animate-spin"})," Loading users..."]}):u?e.jsxs("div",{className:"p-4 text-red-600 bg-red-50 rounded-md",children:[e.jsx(T,{className:"inline-block mr-2"})," ",u]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4",children:e.jsx(k,{id:"search",placeholder:"Search users by name or email...",value:n,onChange:s=>v(s.target.value),icon:e.jsx(F,{size:16})})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium uppercase",children:"Name"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium uppercase",children:"Email"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium uppercase",children:"Role"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium uppercase",children:"Status"}),y==="Owner"&&e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium uppercase",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700",children:i.map(s=>{var r,m;return e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:s.name}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:s.email}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:s.role}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:((r=s.user_status)==null?void 0:r.status)||"N/A"}),y==="Owner"&&e.jsxs("td",{className:"px-4 py-3 whitespace-nowrap text-right text-sm font-medium space-x-2",children:[e.jsx(S,{variant:"icon",onClick:()=>o(s),title:"Toggle Status",children:((m=s.user_status)==null?void 0:m.status)==="active"?e.jsx(H,{className:"text-green-500"}):e.jsx(V,{className:"text-red-500"})}),e.jsx(S,{variant:"icon",onClick:()=>j(s),title:"Edit User",children:e.jsx(B,{size:16})}),e.jsx(S,{variant:"icon",onClick:()=>U(s),title:"Delete User",children:e.jsx(P,{size:16,className:"text-red-600"})})]})]},s.id)})})]})})]})},Q=({isOpen:j,onClose:x,onSave:y,editingUser:a,currentUserRole:c})=>{const[d,h]=t.useState(""),[l,u]=t.useState(""),[p,n]=t.useState("Staff"),[v,g]=t.useState(""),[f,b]=t.useState(!1),[M,N]=t.useState(null);t.useEffect(()=>{a?(h(a.name||""),u(a.email||""),n(a.role||"Staff"),g("")):(h(""),u(""),n("Staff"),g("")),N(null)},[a,j]);const U=async o=>{o.preventDefault(),b(!0),N(null);try{if(a){const{data:i,error:s}=await w.from("users").update({name:d,...c==="Owner"&&{role:p}}).eq("id",a.id).select().single();if(s)throw s;alert("âœ… User updated successfully")}else{if(!v)throw new Error("Password is required for new users.");const{data:i,error:s}=await w.auth.signUp({email:l,password:v,options:{data:{full_name:d,user_role:p}}});if(s)throw s;if(!i.user)throw new Error("Could not create authentication user.");console.log("Auth user created:",i.user);const{error:r}=await w.from("users").insert([{id:i.user.id,name:d,email:l,role:p}]);if(r)throw await w.auth.admin.deleteUser(i.user.id),r;await w.from("user_status").insert([{user_id:i.user.id,status:"active"}]),alert("âœ… User created successfully! They can now log in.")}y(),x()}catch(i){N(i.message||"An unexpected error occurred."),console.error(i)}finally{b(!1)}};return j?e.jsx(z,{onClose:x,title:a?"Edit User":"Add New User",isOpen:j,children:e.jsxs("form",{onSubmit:U,className:"space-y-4 pt-2",children:[M&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-red-50 text-red-700 border border-red-200 rounded-md text-sm",children:[e.jsx(L,{size:18}),e.jsx("span",{children:M})]}),e.jsx(k,{id:"name",label:"Full Name",value:d,onChange:o=>h(o.target.value),required:!0}),e.jsx(k,{id:"email",label:"Email Address",type:"email",value:l,onChange:o=>u(o.target.value),required:!0,disabled:!!a}),!a&&e.jsx(k,{id:"password",label:"Password",type:"password",value:v,onChange:o=>g(o.target.value),placeholder:"Enter a strong password",required:!0}),e.jsx(D,{id:"role",label:"User Role",value:p,onChange:o=>n(o.target.value),options:[{value:"Staff",label:"Staff"},{value:"Manager",label:"Manager"},...c==="Owner"?[{value:"Owner",label:"Owner"}]:[]],required:!0,disabled:c!=="Owner"}),e.jsxs("div",{className:"flex justify-end gap-3 pt-5",children:[e.jsx(S,{type:"button",variant:"outline",onClick:x,disabled:f,children:"Cancel"}),e.jsx(S,{type:"submit",loading:f,variant:"primary",disabled:f,children:f?e.jsx(A,{className:"animate-spin"}):a?"Save Changes":"Create User"})]})]})}):null},le=()=>{const[j,x]=t.useState(0),[y,a]=t.useState(null),[c,d]=t.useState(!1),{user:h,userProfile:l}=q(),u=l==null?void 0:l.role,p=h==null?void 0:h.id,n=()=>{x(f=>f+1)},v=()=>{a(null),d(!0)},g=f=>{a(f),d(!0)};return e.jsxs("div",{className:"p-4 sm:p-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-center gap-4",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-gray-800 dark:text-white",children:"ðŸ‘¥ User Management"}),u==="Owner"&&e.jsxs(S,{onClick:v,variant:"primary",className:"flex items-center w-full sm:w-auto",children:[e.jsx($,{className:"w-5 h-5 mr-2"}),"Add New User"]})]}),e.jsx(R,{children:e.jsx(J,{onEditUser:g,currentUserRole:u,currentUserId:p,onDataChange:n},j)}),c&&e.jsx(Q,{isOpen:c,onClose:()=>d(!1),onSave:n,editingUser:y,currentUserRole:u})]})};export{le as default};
