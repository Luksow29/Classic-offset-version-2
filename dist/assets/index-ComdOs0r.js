import{c as ie,r as u,j as e,s as _,D as $,M as B,a as J,T as Q,L as ae,B as N,V as S,K as oe,h as le,I as ce,G as de,H as he}from"./index-BQ92t-xb.js";import{C as X}from"./Card-Cr9OAgbB.js";import{I as V}from"./Input-BZEgl9G2.js";import{M as me}from"./Modal-BfbFXPiL.js";import{C as ue}from"./clipboard-list-CKxcwzz4.js";import{F as xe}from"./file-x-C7hgEAyV.js";import{C as fe}from"./ConfirmationModal-CFQUW-DD.js";import{S as pe}from"./search-CZ-s9-55.js";import{P as ge}from"./plus-De4zK4eV.js";import{U as ye}from"./user-plus-B6BSmP5E.js";import be from"./star-DyxNfqub.js";import{E as je}from"./eye-B7MUet3E.js";import{S as ve}from"./square-pen-BIVQ8kyS.js";import{T as we}from"./trash-2-DiA01aMl.js";import{A as Ne}from"./arrow-up-down-BPCEvZx4.js";import{C as Ce}from"./CustomerFormModal-B1qZrkVi.js";import"./TextArea-Cp0WOQfX.js";import"./activityLogger-D5lQN0Gb.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["path",{d:"M10 12h11",key:"6m4ad9"}],["path",{d:"M10 18h11",key:"11hvi2"}],["path",{d:"M10 6h11",key:"c7qv1k"}],["path",{d:"M4 10h2",key:"16xx2s"}],["path",{d:"M4 6h1v4",key:"cnovpq"}],["path",{d:"M6 18H4c0-1 2-2 2-3s-1-1.5-2-1",key:"m9a95d"}]],Ee=ie("list-ordered",Se),Me=[{id:1,date:"2023-10-26",type:"Email",notes:"Sent a follow-up email about the new design."},{id:2,date:"2023-10-24",type:"Call",notes:"Discussed the project timeline and budget."}],ze=({customerId:a})=>{const[l,t]=u.useState(Me),[s,n]=u.useState({type:"Call",notes:""}),i=()=>{if(s.notes.trim()==="")return;const r={id:Date.now(),date:new Date().toISOString().split("T")[0],type:s.type,notes:s.notes};t([r,...l]),n({type:"Call",notes:""})};return e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow mt-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Communication Log"}),e.jsxs("div",{className:"flex items-start space-x-3 mb-4",children:[e.jsxs("select",{value:s.type,onChange:r=>n({...s,type:r.target.value}),className:"px-3 py-2 border border-gray-300 rounded-md",children:[e.jsx("option",{children:"Call"}),e.jsx("option",{children:"Email"}),e.jsx("option",{children:"WhatsApp"}),e.jsx("option",{children:"Meeting"})]}),e.jsx("textarea",{value:s.notes,onChange:r=>n({...s,notes:r.target.value}),placeholder:"Add a note...",rows:2,className:"flex-grow p-2 border border-gray-300 rounded-md"}),e.jsx("button",{onClick:i,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Log"})]}),e.jsx("div",{className:"space-y-3",children:l.map(r=>e.jsxs("div",{className:"p-3 bg-gray-50 rounded-md",children:[e.jsxs("p",{className:"font-semibold",children:[r.type," on ",r.date]}),e.jsx("p",{className:"text-gray-600",children:r.notes})]},r.id))})]})},_e=({customerId:a,customerName:l,isOpen:t,onClose:s})=>{const[n,i]=u.useState([]),[r,o]=u.useState([]),[h,x]=u.useState([]),[c,y]=u.useState(!1),[g,j]=u.useState(null),[f,b]=u.useState("orders"),v=u.useCallback(async()=>{if(!(!a||f==="communication")){y(!0),j(null);try{if(f==="orders"){const{data:p,error:m}=await _.from("order_summary_with_dues").select("order_id, total_amount, status, date").eq("customer_id",a).order("date",{ascending:!1});if(m)throw m;i(p||[])}else if(f==="payments"){const{data:p,error:m}=await _.from("payments").select("id, order_id, amount_paid, payment_method, created_at").eq("customer_id",a).order("created_at",{ascending:!1});if(m)throw m;o(p||[])}else if(f==="whatsapp"){const{data:p,error:m}=await _.from("whatsapp_log").select("id, phone, message, template_name, sent_at").eq("customer_id",a).order("sent_at",{ascending:!1});if(m)throw m;x(p||[])}}catch(p){console.error(`Error fetching ${f} for customer:`,p),j(p.message||`An unknown error occurred while fetching ${f}.`)}finally{y(!1)}}},[a,f]);u.useEffect(()=>{t&&v()},[t,a,f,v]);const w=()=>{if(c)return e.jsx("div",{className:"flex justify-center items-center py-10",children:e.jsx(J,{className:"w-8 h-8 animate-spin text-primary-500"})});if(g)return e.jsxs("div",{className:"py-10 text-center text-red-600",children:[e.jsx(Q,{className:"mx-auto h-8 w-8 mb-2"}),e.jsx("p",{children:g})]});switch(f){case"orders":return n.length===0?e.jsxs("div",{className:"text-center py-10 text-gray-500",children:[e.jsx(xe,{className:"mx-auto h-10 w-10 mb-2"}),e.jsx("p",{children:"No orders found for this customer."})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full table-auto text-sm",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700/50 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2",children:"Order #"}),e.jsx("th",{className:"px-4 py-2",children:"Total"}),e.jsx("th",{className:"px-4 py-2",children:"Status"}),e.jsx("th",{className:"px-4 py-2",children:"Date"}),e.jsx("th",{className:"px-4 py-2"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:n.map(m=>e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[e.jsxs("td",{className:"px-4 py-2 font-medium",children:["#",m.order_id]}),e.jsxs("td",{className:"px-4 py-2",children:["₹",m.total_amount.toLocaleString("en-IN")]}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("span",{className:`px-2 py-1 text-xs rounded-full font-medium ${m.status==="Delivered"?"bg-green-100 text-green-700":"bg-red-100 text-red-700"}`,children:m.status||"N/A"})}),e.jsx("td",{className:"px-4 py-2",children:new Date(m.date).toLocaleDateString("en-GB")}),e.jsx("td",{className:"px-4 py-2 text-right",children:e.jsx(ae,{to:`/invoices/${m.order_id}`,children:e.jsx(N,{variant:"link",size:"sm",children:"View Invoice"})})})]},m.order_id))})]})});case"payments":return r.length===0?e.jsxs("div",{className:"text-center py-10 text-gray-500",children:[e.jsx($,{className:"mx-auto h-10 w-10 mb-2"}),e.jsx("p",{children:"No payment records found."})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full table-auto text-sm",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700/50 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2",children:"Payment ID"}),e.jsx("th",{className:"px-4 py-2",children:"Order #"}),e.jsx("th",{className:"px-4 py-2",children:"Amount Paid"}),e.jsx("th",{className:"px-4 py-2",children:"Method"}),e.jsx("th",{className:"px-4 py-2",children:"Date"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:r.map(m=>e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[e.jsx("td",{className:"px-4 py-2 max-w-xs truncate",children:m.id}),e.jsxs("td",{className:"px-4 py-2",children:["#",m.order_id]}),e.jsxs("td",{className:"px-4 py-2",children:["₹",m.amount_paid.toLocaleString("en-IN")]}),e.jsx("td",{className:"px-4 py-2",children:m.payment_method||"-"}),e.jsx("td",{className:"px-4 py-2",children:new Date(m.created_at).toLocaleDateString("en-GB")})]},m.id))})]})});case"whatsapp":return h.length===0?e.jsxs("div",{className:"text-center py-10 text-gray-500",children:[e.jsx(B,{className:"mx-auto h-10 w-10 mb-2"}),e.jsx("p",{children:"No WhatsApp logs found."})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full table-auto text-sm",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700/50 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2",children:"Phone"}),e.jsx("th",{className:"px-4 py-2",children:"Message"}),e.jsx("th",{className:"px-4 py-2",children:"Template"}),e.jsx("th",{className:"px-4 py-2",children:"Date"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:h.map(m=>e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[e.jsx("td",{className:"px-4 py-2",children:m.phone}),e.jsx("td",{className:"px-4 py-2 max-w-xs truncate",children:m.message}),e.jsx("td",{className:"px-4 py-2",children:m.template_name||"-"}),e.jsx("td",{className:"px-4 py-2",children:new Date(m.sent_at).toLocaleDateString("en-GB")})]},m.id))})]})});case"communication":const p=parseInt(a,10);return isNaN(p)?e.jsx("div",{className:"text-center py-10 text-red-500",children:"Invalid Customer ID"}):e.jsx(ze,{customerId:p});default:return null}};return e.jsxs(me,{isOpen:t,onClose:s,title:`Customer Details: ${l}`,size:"3xl",children:[e.jsx("div",{className:"border-b border-gray-200 dark:border-gray-700 mb-4",children:e.jsxs("nav",{className:"-mb-px flex space-x-6 overflow-x-auto",children:[e.jsxs("button",{className:`flex items-center gap-2 px-1 py-3 text-sm font-medium whitespace-nowrap border-b-2 ${f==="orders"?"border-primary-600 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700"}`,onClick:()=>b("orders"),children:[e.jsx(Ee,{size:16})," Orders"]}),e.jsxs("button",{className:`flex items-center gap-2 px-1 py-3 text-sm font-medium whitespace-nowrap border-b-2 ${f==="payments"?"border-primary-600 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700"}`,onClick:()=>b("payments"),children:[e.jsx($,{size:16})," Payments"]}),e.jsxs("button",{className:`flex items-center gap-2 px-1 py-3 text-sm font-medium whitespace-nowrap border-b-2 ${f==="whatsapp"?"border-primary-600 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700"}`,onClick:()=>b("whatsapp"),children:[e.jsx(B,{size:16})," WhatsApp Logs"]}),e.jsxs("button",{className:`flex items-center gap-2 px-1 py-3 text-sm font-medium whitespace-nowrap border-b-2 ${f==="communication"?"border-primary-600 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700"}`,onClick:()=>b("communication"),children:[e.jsx(ue,{size:16})," Communication Log"]})]})}),e.jsx("div",{children:w()})]})},ke=()=>{const a=()=>{try{const n=["Name,Email,Phone,Address,JoinedDate,Tags",...["John Doe,john@example.com,123-456-7890,123 Main St,2023-01-15,VIP;New","Jane Smith,jane@example.com,987-654-3210,456 Oak Ave,2023-02-20,Wholesale"]].join(`
`),i="data:text/csv;charset=utf-8,"+encodeURIComponent(n),r=document.createElement("a");r.setAttribute("href",i),r.setAttribute("download","customers.csv"),document.body.appendChild(r),r.click(),document.body.removeChild(r),S.success("Customer data exported!")}catch(t){console.error("Failed to export customers:",t),S.error("Could not export customer data.")}},l=t=>{var n;const s=(n=t.target.files)==null?void 0:n[0];s&&S.success(`File "${s.name}" selected. Import processing would happen here.`)};return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("label",{className:"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 cursor-pointer text-sm font-medium",children:[e.jsx("span",{children:"Import"}),e.jsx("input",{type:"file",className:"hidden",accept:".csv",onChange:l})]}),e.jsx("button",{onClick:a,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium",children:"Export"})]})};function M(a,l,t){let s=t.initialDeps??[],n;function i(){var r,o,h,x;let c;t.key&&((r=t.debug)!=null&&r.call(t))&&(c=Date.now());const y=a();if(!(y.length!==s.length||y.some((f,b)=>s[b]!==f)))return n;s=y;let j;if(t.key&&((o=t.debug)!=null&&o.call(t))&&(j=Date.now()),n=l(...y),t.key&&((h=t.debug)!=null&&h.call(t))){const f=Math.round((Date.now()-c)*100)/100,b=Math.round((Date.now()-j)*100)/100,v=b/16,w=(p,m)=>{for(p=String(p);p.length<m;)p=" "+p;return p};console.info(`%c⏱ ${w(b,5)} /${w(f,5)} ms`,`
            font-size: .6rem;
            font-weight: bold;
            color: hsl(${Math.max(0,Math.min(120-120*v,120))}deg 100% 31%);`,t==null?void 0:t.key)}return(x=t==null?void 0:t.onChange)==null||x.call(t,n),n}return i.updateDeps=r=>{s=r},i}function q(a,l){if(a===void 0)throw new Error("Unexpected undefined");return a}const Oe=(a,l)=>Math.abs(a-l)<1.01,Ie=(a,l,t)=>{let s;return function(...n){a.clearTimeout(s),s=a.setTimeout(()=>l.apply(this,n),t)}},U=a=>{const{offsetWidth:l,offsetHeight:t}=a;return{width:l,height:t}},De=a=>a,Ae=a=>{const l=Math.max(a.startIndex-a.overscan,0),t=Math.min(a.endIndex+a.overscan,a.count-1),s=[];for(let n=l;n<=t;n++)s.push(n);return s},Te=(a,l)=>{const t=a.scrollElement;if(!t)return;const s=a.targetWindow;if(!s)return;const n=r=>{const{width:o,height:h}=r;l({width:Math.round(o),height:Math.round(h)})};if(n(U(t)),!s.ResizeObserver)return()=>{};const i=new s.ResizeObserver(r=>{const o=()=>{const h=r[0];if(h!=null&&h.borderBoxSize){const x=h.borderBoxSize[0];if(x){n({width:x.inlineSize,height:x.blockSize});return}}n(U(t))};a.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(o):o()});return i.observe(t,{box:"border-box"}),()=>{i.unobserve(t)}},H={passive:!0},G=typeof window>"u"?!0:"onscrollend"in window,Fe=(a,l)=>{const t=a.scrollElement;if(!t)return;const s=a.targetWindow;if(!s)return;let n=0;const i=a.options.useScrollendEvent&&G?()=>{}:Ie(s,()=>{l(n,!1)},a.options.isScrollingResetDelay),r=c=>()=>{const{horizontal:y,isRtl:g}=a.options;n=y?t.scrollLeft*(g&&-1||1):t.scrollTop,i(),l(n,c)},o=r(!0),h=r(!1);h(),t.addEventListener("scroll",o,H);const x=a.options.useScrollendEvent&&G;return x&&t.addEventListener("scrollend",h,H),()=>{t.removeEventListener("scroll",o),x&&t.removeEventListener("scrollend",h)}},Le=(a,l,t)=>{if(l!=null&&l.borderBoxSize){const s=l.borderBoxSize[0];if(s)return Math.round(s[t.options.horizontal?"inlineSize":"blockSize"])}return a[t.options.horizontal?"offsetWidth":"offsetHeight"]},Re=(a,{adjustments:l=0,behavior:t},s)=>{var n,i;const r=a+l;(i=(n=s.scrollElement)==null?void 0:n.scrollTo)==null||i.call(n,{[s.options.horizontal?"left":"top"]:r,behavior:t})};class Pe{constructor(l){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.measurementsCache=[],this.itemSizeCache=new Map,this.pendingMeasuredCacheIndexes=[],this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let t=null;const s=()=>t||(!this.targetWindow||!this.targetWindow.ResizeObserver?null:t=new this.targetWindow.ResizeObserver(n=>{n.forEach(i=>{const r=()=>{this._measureElement(i.target,i)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(r):r()})}));return{disconnect:()=>{var n;(n=s())==null||n.disconnect(),t=null},observe:n=>{var i;return(i=s())==null?void 0:i.observe(n,{box:"border-box"})},unobserve:n=>{var i;return(i=s())==null?void 0:i.unobserve(n)}}})(),this.range=null,this.setOptions=t=>{Object.entries(t).forEach(([s,n])=>{typeof n>"u"&&delete t[s]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:De,rangeExtractor:Ae,onChange:()=>{},measureElement:Le,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:"data-index",initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...t}},this.notify=t=>{var s,n;(n=(s=this.options).onChange)==null||n.call(s,this,t)},this.maybeNotify=M(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),t=>{this.notify(t)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(t=>t()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{var t;const s=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==s){if(this.cleanup(),!s){this.maybeNotify();return}this.scrollElement=s,this.scrollElement&&"ownerDocument"in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=((t=this.scrollElement)==null?void 0:t.window)??null,this.elementsCache.forEach(n=>{this.observer.observe(n)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,n=>{this.scrollRect=n,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(n,i)=>{this.scrollAdjustments=0,this.scrollDirection=i?this.getScrollOffset()<n?"forward":"backward":null,this.scrollOffset=n,this.isScrolling=i,this.maybeNotify()}))}},this.getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?"width":"height"]):(this.scrollRect=null,0),this.getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??(typeof this.options.initialOffset=="function"?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0),this.getFurthestMeasurement=(t,s)=>{const n=new Map,i=new Map;for(let r=s-1;r>=0;r--){const o=t[r];if(n.has(o.lane))continue;const h=i.get(o.lane);if(h==null||o.end>h.end?i.set(o.lane,o):o.end<h.end&&n.set(o.lane,!0),n.size===this.options.lanes)break}return i.size===this.options.lanes?Array.from(i.values()).sort((r,o)=>r.end===o.end?r.index-o.index:r.end-o.end)[0]:void 0},this.getMeasurementOptions=M(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled],(t,s,n,i,r)=>(this.pendingMeasuredCacheIndexes=[],{count:t,paddingStart:s,scrollMargin:n,getItemKey:i,enabled:r}),{key:!1}),this.getMeasurements=M(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:t,paddingStart:s,scrollMargin:n,getItemKey:i,enabled:r},o)=>{if(!r)return this.measurementsCache=[],this.itemSizeCache.clear(),[];this.measurementsCache.length===0&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(c=>{this.itemSizeCache.set(c.key,c.size)}));const h=this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[];const x=this.measurementsCache.slice(0,h);for(let c=h;c<t;c++){const y=i(c),g=this.options.lanes===1?x[c-1]:this.getFurthestMeasurement(x,c),j=g?g.end+this.options.gap:s+n,f=o.get(y),b=typeof f=="number"?f:this.options.estimateSize(c),v=j+b,w=g?g.lane:c%this.options.lanes;x[c]={index:c,start:j,size:b,end:v,key:y,lane:w}}return this.measurementsCache=x,x},{key:!1,debug:()=>this.options.debug}),this.calculateRange=M(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(t,s,n,i)=>this.range=t.length>0&&s>0?We({measurements:t,outerSize:s,scrollOffset:n,lanes:i}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=M(()=>{let t=null,s=null;const n=this.calculateRange();return n&&(t=n.startIndex,s=n.endIndex),this.maybeNotify.updateDeps([this.isScrolling,t,s]),[this.options.rangeExtractor,this.options.overscan,this.options.count,t,s]},(t,s,n,i,r)=>i===null||r===null?[]:t({startIndex:i,endIndex:r,overscan:s,count:n}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=t=>{const s=this.options.indexAttribute,n=t.getAttribute(s);return n?parseInt(n,10):(console.warn(`Missing attribute name '${s}={index}' on measured element.`),-1)},this._measureElement=(t,s)=>{const n=this.indexFromElement(t),i=this.measurementsCache[n];if(!i)return;const r=i.key,o=this.elementsCache.get(r);o!==t&&(o&&this.observer.unobserve(o),this.observer.observe(t),this.elementsCache.set(r,t)),t.isConnected&&this.resizeItem(n,this.options.measureElement(t,s,this))},this.resizeItem=(t,s)=>{const n=this.measurementsCache[t];if(!n)return;const i=this.itemSizeCache.get(n.key)??n.size,r=s-i;r!==0&&((this.shouldAdjustScrollPositionOnItemSizeChange!==void 0?this.shouldAdjustScrollPositionOnItemSizeChange(n,r,this):n.start<this.getScrollOffset()+this.scrollAdjustments)&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=r,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(n.index),this.itemSizeCache=new Map(this.itemSizeCache.set(n.key,s)),this.notify(!1))},this.measureElement=t=>{if(!t){this.elementsCache.forEach((s,n)=>{s.isConnected||(this.observer.unobserve(s),this.elementsCache.delete(n))});return}this._measureElement(t,void 0)},this.getVirtualItems=M(()=>[this.getVirtualIndexes(),this.getMeasurements()],(t,s)=>{const n=[];for(let i=0,r=t.length;i<r;i++){const o=t[i],h=s[o];n.push(h)}return n},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=t=>{const s=this.getMeasurements();if(s.length!==0)return q(s[Y(0,s.length-1,n=>q(s[n]).start,t)])},this.getOffsetForAlignment=(t,s,n=0)=>{const i=this.getSize(),r=this.getScrollOffset();s==="auto"&&(s=t>=r+i?"end":"start"),s==="center"?t+=(n-i)/2:s==="end"&&(t-=i);const o=this.getTotalSize()+this.options.scrollMargin-i;return Math.max(Math.min(o,t),0)},this.getOffsetForIndex=(t,s="auto")=>{t=Math.max(0,Math.min(t,this.options.count-1));const n=this.measurementsCache[t];if(!n)return;const i=this.getSize(),r=this.getScrollOffset();if(s==="auto")if(n.end>=r+i-this.options.scrollPaddingEnd)s="end";else if(n.start<=r+this.options.scrollPaddingStart)s="start";else return[r,s];const o=s==="end"?n.end+this.options.scrollPaddingEnd:n.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(o,s,n.size),s]},this.isDynamicMode=()=>this.elementsCache.size>0,this.scrollToOffset=(t,{align:s="start",behavior:n}={})=>{n==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getOffsetForAlignment(t,s),{adjustments:void 0,behavior:n})},this.scrollToIndex=(t,{align:s="auto",behavior:n}={})=>{n==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),t=Math.max(0,Math.min(t,this.options.count-1));let i=0;const r=10,o=x=>{if(!this.targetWindow)return;const c=this.getOffsetForIndex(t,x);if(!c){console.warn("Failed to get offset for index:",t);return}const[y,g]=c;this._scrollToOffset(y,{adjustments:void 0,behavior:n}),this.targetWindow.requestAnimationFrame(()=>{const j=this.getScrollOffset(),f=this.getOffsetForIndex(t,g);if(!f){console.warn("Failed to get offset for index:",t);return}Oe(f[0],j)||h(g)})},h=x=>{this.targetWindow&&(i++,i<r?this.targetWindow.requestAnimationFrame(()=>o(x)):console.warn(`Failed to scroll to index ${t} after ${r} attempts.`))};o(s)},this.scrollBy=(t,{behavior:s}={})=>{s==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getScrollOffset()+t,{adjustments:void 0,behavior:s})},this.getTotalSize=()=>{var t;const s=this.getMeasurements();let n;if(s.length===0)n=this.options.paddingStart;else if(this.options.lanes===1)n=((t=s[s.length-1])==null?void 0:t.end)??0;else{const i=Array(this.options.lanes).fill(null);let r=s.length-1;for(;r>=0&&i.some(o=>o===null);){const o=s[r];i[o.lane]===null&&(i[o.lane]=o.end),r--}n=Math.max(...i.filter(o=>o!==null))}return Math.max(n-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(t,{adjustments:s,behavior:n})=>{this.options.scrollToFn(t,{behavior:n,adjustments:s},this)},this.measure=()=>{this.itemSizeCache=new Map,this.notify(!1)},this.setOptions(l)}}const Y=(a,l,t,s)=>{for(;a<=l;){const n=(a+l)/2|0,i=t(n);if(i<s)a=n+1;else if(i>s)l=n-1;else return n}return a>0?a-1:0};function We({measurements:a,outerSize:l,scrollOffset:t,lanes:s}){const n=a.length-1,i=h=>a[h].start;if(a.length<=s)return{startIndex:0,endIndex:n};let r=Y(0,n,i,t),o=r;if(s===1)for(;o<n&&a[o].end<t+l;)o++;else if(s>1){const h=Array(s).fill(0);for(;o<n&&h.some(c=>c<t+l);){const c=a[o];h[c.lane]=c.end,o++}const x=Array(s).fill(t+l);for(;r>=0&&x.some(c=>c>=t);){const c=a[r];x[c.lane]=c.start,r--}r=Math.max(0,r-r%s),o=Math.min(n,o+(s-1-o%s))}return{startIndex:r,endIndex:o}}const K=typeof document<"u"?u.useLayoutEffect:u.useEffect;function $e(a){const l=u.useReducer(()=>({}),{})[1],t={...a,onChange:(n,i)=>{var r;i?oe.flushSync(l):l(),(r=a.onChange)==null||r.call(a,n,i)}},[s]=u.useState(()=>new Pe(t));return s.setOptions(t),K(()=>s._didMount(),[]),K(()=>s._willUpdate()),s}function Be(a){return $e({observeElementRect:Te,observeElementOffset:Fe,scrollToFn:Re,...a})}const T=10,Ve=({onAddNew:a,onEdit:l,onDataChange:t})=>{const{userProfile:s}=le(),[n,i]=u.useState([]),[r,o]=u.useState(!0),[h,x]=u.useState(null),[c,y]=u.useState(""),[g,j]=u.useState(""),[f,b]=u.useState("joined_date"),[v,w]=u.useState("desc"),[p,m]=u.useState(1),[F,Z]=u.useState(0),[k,L]=u.useState(null),[z,R]=u.useState(null),[P,I]=u.useState(!1),ee=ce.useRef(null);u.useEffect(()=>{m(1)},[c,g,f,v]);const D=u.useCallback(async()=>{o(!0),x(null);try{let d=_.from("customer_summary").select("*",{count:"exact"});c&&(d=d.or(`name.ilike.%${c}%,phone.ilike.%${c}%,email.ilike.%${c}%`)),g&&(d=d.contains("tags",[g])),d=d.order(f,{ascending:v==="asc"});const C=(p-1)*T,E=C+T-1;d=d.range(C,E);const{data:ne,error:W,count:re}=await d;if(W)throw W;i(ne||[]),Z(re||0)}catch(d){x(`Failed to load customers: ${d.message}`),S.error("Failed to load customers.")}finally{o(!1)}},[c,g,f,v,p]);u.useEffect(()=>{D()},[D,t]);const A=Math.ceil(F/T),te=d=>{if(!s||s.role!=="Owner"){S.error("Permission denied: Only Owners can delete customers.");return}R(d),I(!0)},se=async()=>{if(z){o(!0);try{const{error:d}=await _.rpc("delete_customer_and_related_data",{customer_id_to_delete:z.id});if(d)throw d;S.success("Customer deleted successfully!"),D(),I(!1),R(null)}catch(d){S.error(`Failed to delete customer: ${d.message}`)}finally{o(!1)}}},O=({field:d,children:C})=>e.jsxs("button",{onClick:()=>{b(d),w(E=>f===d&&E==="asc"?"desc":"asc")},className:"flex items-center gap-1 text-muted-foreground hover:text-foreground",children:[C,e.jsx(Ne,{size:14,className:f===d?"text-primary":""})]});return Be({count:n.length,getScrollElement:()=>ee.current,estimateSize:()=>60,overscan:5}),e.jsxs(X,{children:[e.jsxs("div",{className:"p-4 border-b space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-center gap-4",children:[e.jsxs("div",{className:"relative w-full sm:w-1/3",children:[e.jsx(pe,{className:"w-4 h-4 text-muted-foreground absolute top-1/2 left-3 -translate-y-1/2"}),e.jsx(V,{id:"search-customers",placeholder:"Search by name, phone, or email...",value:c,onChange:d=>y(d.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ke,{}),e.jsxs(N,{onClick:a,size:"sm",className:"w-full sm:w-auto",children:[e.jsx(ge,{className:"w-4 h-4 mr-2"})," Add New Customer"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(V,{id:"tag-filter",label:"Filter by Tag",placeholder:"e.g., VIP, Wholesale",value:g,onChange:d=>j(d.target.value)}),e.jsx(N,{onClick:()=>{y(""),j("")},variant:"outline",className:"self-end",children:"Clear Filters"})]})]}),r?e.jsxs("div",{className:"flex justify-center items-center py-12",children:[e.jsx(J,{className:"w-8 h-8 animate-spin text-primary"}),e.jsx("span",{className:"ml-2 text-muted-foreground",children:"Loading customers..."})]}):h?e.jsxs("div",{className:"p-6 bg-destructive/10 text-destructive text-center",children:[e.jsx(Q,{className:"w-10 h-10 mx-auto mb-2"}),e.jsx("p",{className:"font-semibold",children:"Error Loading Customers"}),e.jsx("p",{className:"text-sm",children:h})]}):n.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(ye,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"font-semibold text-lg",children:"No customers found."}),e.jsx("p",{className:"text-sm",children:"Try adjusting your filters or add a new customer."})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-muted",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium text-muted-foreground",children:e.jsx(O,{field:"name",children:"Customer"})}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-muted-foreground",children:"Contact"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-muted-foreground",children:"Tags"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-muted-foreground",children:e.jsx(O,{field:"total_orders",children:"Orders"})}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-muted-foreground",children:e.jsx(O,{field:"balance_due",children:"Balance Due"})}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-muted-foreground",children:e.jsx(O,{field:"joined_date",children:"Joined"})}),e.jsx("th",{className:"px-4 py-3 text-center font-medium text-muted-foreground",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y",children:n.map(d=>{var C;return e.jsxs("tr",{children:[e.jsxs("td",{className:"px-4 py-3 font-medium text-foreground flex items-center gap-2",children:[(d.total_spent||0)>1e4&&e.jsx(be,{size:14,className:"text-yellow-500 fill-current",title:"Premium Customer"}),d.name]}),e.jsxs("td",{className:"px-4 py-3 text-muted-foreground",children:[e.jsx("div",{children:d.phone}),e.jsx("div",{className:"text-xs",children:d.email})]}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"flex flex-wrap gap-1",children:(C=d.tags)==null?void 0:C.map(E=>e.jsx("span",{className:"px-2 py-0.5 text-xs rounded-full bg-secondary text-secondary-foreground",children:E},E))})}),e.jsx("td",{className:"px-4 py-3 text-right text-foreground",children:d.total_orders||0}),e.jsxs("td",{className:`px-4 py-3 text-right font-bold ${(d.balance_due||0)>0?"text-red-600":"text-green-600"}`,children:["₹",(d.balance_due||0).toLocaleString("en-IN")]}),e.jsx("td",{className:"px-4 py-3 text-muted-foreground",children:new Date(d.joined_date).toLocaleDateString("en-GB")}),e.jsxs("td",{className:"px-4 py-3 text-center space-x-1",children:[e.jsx(N,{variant:"ghost",size:"sm",title:"View Details",onClick:()=>L(d),children:e.jsx(je,{size:16})}),e.jsx(N,{variant:"ghost",size:"sm",title:"Edit Customer",onClick:()=>l(d),children:e.jsx(ve,{size:16})}),e.jsx(N,{variant:"ghost",size:"sm",title:"Delete Customer",onClick:()=>te(d),children:e.jsx(we,{size:16,className:"text-destructive"})})]})]},d.id)})})]})}),A>0&&e.jsxs("div",{className:"flex justify-between items-center p-4 border-t",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Page ",p," of ",A," (",F," total)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(N,{onClick:()=>m(d=>d-1),disabled:p===1,variant:"outline",size:"sm",children:[e.jsx(de,{size:16})," Prev"]}),e.jsxs(N,{onClick:()=>m(d=>d+1),disabled:p>=A,variant:"outline",size:"sm",children:["Next ",e.jsx(he,{size:16})]})]})]}),k&&e.jsx(_e,{customerId:k.id,customerName:k.name,isOpen:!!k,onClose:()=>L(null)}),P&&e.jsx(fe,{isOpen:P,onClose:()=>I(!1),onConfirm:se,title:"Delete Customer",description:`Delete ${z==null?void 0:z.name}? This is irreversible.`,confirmText:"Delete"})]})},lt=()=>{const[a,l]=u.useState(null),[t,s]=u.useState(!1),[n,i]=u.useState(0),r=c=>{l(c),s(!0)},o=()=>{l(null),s(!0)},h=()=>{s(!1),l(null)},x=()=>{i(c=>c+1),h()};return e.jsxs("div",{className:"p-4 sm:p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:"Customers"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"Manage your print shop customers"})]}),e.jsx(X,{children:e.jsx(Ve,{onEdit:r,onAddNew:o},n)}),t&&e.jsx(Ce,{isOpen:t,onClose:h,onSuccess:x,customerToEdit:a})]})};export{lt as default};
