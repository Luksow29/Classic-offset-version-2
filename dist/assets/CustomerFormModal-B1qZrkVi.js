import{r as h,j as a,h as O,i as k,B as C,a as q,V as j,s as D,b as B,d as F,e as $,f as U}from"./index-BQ92t-xb.js";import{M as L}from"./Modal-BfbFXPiL.js";import{I as u}from"./Input-BZEgl9G2.js";import{T as _}from"./TextArea-Cp0WOQfX.js";import{l as P}from"./activityLogger-D5lQN0Gb.js";const R=({initialTags:s=[],onTagsChange:t})=>{const[l,d]=h.useState(s),[e,o]=h.useState(""),n=()=>{if(e.trim()&&!l.includes(e.trim())){const r=[...l,e.trim()];d(r),t(r),o("")}},x=r=>{const m=l.filter(i=>i!==r);d(m),t(m)};return a.jsxs("div",{children:[a.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:l.map(r=>a.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800",children:[r,a.jsx("button",{onClick:()=>x(r),className:"ml-1.5 text-blue-600 hover:text-blue-800",children:"×"})]},r))}),a.jsxs("div",{className:"flex",children:[a.jsx("input",{type:"text",value:e,onChange:r=>o(r.target.value),onKeyDown:r=>r.key==="Enter"&&n(),className:"flex-grow p-2 border border-gray-300 rounded-l-md",placeholder:"Add a tag..."}),a.jsx("button",{onClick:n,className:"px-4 py-2 bg-gray-200 text-gray-700 rounded-r-md hover:bg-gray-300",children:"Add"})]})]})},V=({selectedCustomer:s,onSave:t,onCancel:l})=>{const{userProfile:d}=O(),[e,o]=h.useState({name:"",phone:"",email:"",address:"",joined_date:new Date().toISOString().split("T")[0],secondary_phone:"",company_name:"",billing_address:"",shipping_address:"",birthday:"",tags:[]}),[n,x]=h.useState(!1),[r,m]=h.useState(null);h.useEffect(()=>{o(s?{name:s.name||"",phone:s.phone||"",email:s.email||"",address:s.address||"",joined_date:s.joined_date||new Date().toISOString().split("T")[0],secondary_phone:s.secondary_phone||"",company_name:s.company_name||"",billing_address:s.billing_address||"",shipping_address:s.shipping_address||"",birthday:s.birthday||"",tags:s.tags||[]}:{name:"",phone:"",email:"",address:"",joined_date:new Date().toISOString().split("T")[0],secondary_phone:"",company_name:"",billing_address:"",shipping_address:"",birthday:"",tags:[]}),m(null)},[s]);const i=g=>{const{id:c,value:y}=g.target;o({...e,[c]:y})},I=g=>{o({...e,tags:g})},E=async g=>{var y,f,v,w,N,S;if(g.preventDefault(),m(null),!d||d.role!=="Owner"&&d.role!=="Manager"){j.error("Permission denied: Only Owners and Managers can add/edit customers.");return}if(!e.name.trim()||!e.phone.trim()){m("Name and phone number are required.");return}x(!0);const c={name:e.name.trim(),phone:e.phone.trim(),email:((y=e.email)==null?void 0:y.trim())||null,address:((f=e.address)==null?void 0:f.trim())||null,joined_date:e.joined_date,secondary_phone:((v=e.secondary_phone)==null?void 0:v.trim())||null,company_name:((w=e.company_name)==null?void 0:w.trim())||null,billing_address:((N=e.billing_address)==null?void 0:N.trim())||null,shipping_address:((S=e.shipping_address)==null?void 0:S.trim())||null,birthday:e.birthday||null,tags:e.tags};try{let p;if(s){const{error:b}=await D.from("customers").update(c).eq("id",s.id);if(b)throw b}else{const{data:b,error:T}=await D.from("customers").insert(c).select().single();if(T||!b)throw T||new Error("Failed to create customer.");p=b.id}j.success(`✅ Customer ${s?"updated":"added"} successfully!`);const A=(d==null?void 0:d.name)||"Admin",M=s?`Updated details for customer "${c.name}"`:`Added a new customer: "${c.name}"`;await P(M,A),!s&&p&&await B(F($,"notifications"),{message:`New customer "${c.name}" has been added.`,type:"customer_created",relatedId:p,timestamp:U(),read:!1,triggeredBy:A}),t()}catch(p){console.error("Error saving customer:",p),m(p.message||"An unexpected error occurred."),j.error(`❌ Failed to save customer: ${p.message||"An unexpected error occurred."}`)}finally{x(!1)}};return a.jsxs("form",{onSubmit:E,className:"space-y-4",children:[r&&a.jsxs("div",{className:"flex items-center gap-2 p-3 bg-red-50 text-red-700 border border-red-200 rounded-md text-sm",children:[a.jsx(k,{size:18}),a.jsx("span",{children:r})]}),a.jsx(u,{id:"name",label:"Customer Name *",value:e.name,onChange:i,required:!0,disabled:n}),a.jsx(u,{id:"phone",label:"Phone Number *",type:"tel",value:e.phone,onChange:i,required:!0,disabled:n}),a.jsx(u,{id:"secondary_phone",label:"Secondary Phone",type:"tel",value:e.secondary_phone,onChange:i,disabled:n}),a.jsx(u,{id:"email",label:"Email",type:"email",value:e.email,onChange:i,disabled:n}),a.jsx(u,{id:"company_name",label:"Company Name",value:e.company_name,onChange:i,disabled:n}),a.jsx(_,{id:"address",label:"Address",value:e.address,onChange:i,rows:3,disabled:n}),a.jsx(_,{id:"billing_address",label:"Billing Address",value:e.billing_address,onChange:i,rows:3,disabled:n}),a.jsx(_,{id:"shipping_address",label:"Shipping Address",value:e.shipping_address,onChange:i,rows:3,disabled:n}),a.jsx(u,{id:"birthday",label:"Birthday",type:"date",value:e.birthday,onChange:i,disabled:n}),a.jsx(u,{id:"joined_date",label:"Joined Date",type:"date",value:e.joined_date,onChange:i,required:!0,disabled:n}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tags"}),a.jsx(R,{initialTags:e.tags,onTagsChange:I})]}),a.jsxs("div",{className:"flex justify-end gap-3 pt-2",children:[a.jsx(C,{type:"button",variant:"outline",onClick:l,disabled:n,children:"Cancel"}),a.jsx(C,{type:"submit",variant:"primary",disabled:n,children:n?a.jsx(q,{className:"w-5 h-5 animate-spin"}):s?"Update Customer":"Add Customer"})]})]})},Q=({isOpen:s,onClose:t,onSuccess:l,customerToEdit:d})=>{const e=()=>{l(d||{}),t()};return a.jsx(L,{isOpen:s,onClose:t,title:d?"Edit Customer":"Add a New Customer",children:a.jsx("div",{className:"p-6",children:a.jsx(V,{selectedCustomer:d||null,onSave:e,onCancel:t})})})};export{Q as C};
