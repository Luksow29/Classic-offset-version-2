import{v as U,h as _,r,j as e,B as E,a as V,V as R,b as F,d as k,e as N,f as C,q as I,x as q,y as L,w as G,M as Q,z as H,E as J}from"./index-BQ92t-xb.js";import{d as b,r as K}from"./relativeTime-BJSYrNG1.js";import{M as X}from"./Modal-BfbFXPiL.js";import{I as O}from"./Input-BZEgl9G2.js";import{S as Z}from"./send-DvzX1HMZ.js";import{C as ee}from"./circle-plus-uaTjFC1H.js";var D={exports:{}},te=D.exports,$;function se(){return $||($=1,function(d,m){(function(f,n){d.exports=n()})(te,function(){return function(f,n,a){var l="h:mm A",o={lastDay:"[Yesterday at] "+l,sameDay:"[Today at] "+l,nextDay:"[Tomorrow at] "+l,nextWeek:"dddd [at] "+l,lastWeek:"[Last] dddd [at] "+l,sameElse:"MM/DD/YYYY"};n.prototype.calendar=function(u,c){var x=c||this.$locale().calendar||o,g=a(u||void 0).startOf("d"),i=this.diff(g,"d",!0),v="sameElse",M=i<-6?v:i<-1?"lastWeek":i<0?"lastDay":i<1?"sameDay":i<2?"nextDay":i<7?"nextWeek":v,j=x[M]||o[M];return typeof j=="function"?j.call(this,a()):this.format(j)}}})}(D)),D.exports}var ae=se();const re=U(ae),oe=({isOpen:d,onClose:m})=>{const{user:f,userProfile:n}=_(),[a,l]=r.useState(""),[o,u]=r.useState(!1),c=async x=>{if(x.preventDefault(),a.trim()===""||!n||!f){R.error("Topic cannot be empty and you must be logged in!");return}u(!0);try{await F(k(N,"chat_rooms"),{topic:a.trim(),createdBy:{id:f.id,name:n.name,role:n.role},createdAt:C(),lastMessage:`Chat room created by ${n.name}`,lastMessageAt:C()}),R.success("New chat room created!"),l(""),m()}catch(g){console.error("Error creating chat room: ",g),R.error(g.message||"Failed to create chat room.")}finally{u(!1)}};return e.jsx(X,{isOpen:d,onClose:m,title:"Start a New Chat Room",children:e.jsxs("form",{onSubmit:c,className:"space-y-4 pt-2",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Create a new chat room to discuss a specific topic with your team."}),e.jsx(O,{id:"topic",label:"Chat Topic",value:a,onChange:x=>l(x.target.value),placeholder:"e.g., Q4 Marketing Plan, Urgent Delivery Updates",required:!0,disabled:o,autoFocus:!0}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx(E,{type:"button",variant:"outline",onClick:m,disabled:o,children:"Cancel"}),e.jsx(E,{type:"submit",variant:"primary",disabled:o||!a.trim(),children:o?e.jsx(V,{className:"w-5 h-5 animate-spin"}):"Create Room"})]})]})})};b.extend(K);b.extend(re);const xe=()=>{const{user:d,userProfile:m}=_(),[f,n]=r.useState([]),[a,l]=r.useState(null),[o,u]=r.useState({}),[c,x]=r.useState(""),[g,i]=r.useState(!1),[v,M]=r.useState(!0),[j,Y]=r.useState(!1),A=r.useRef(null),P=()=>{var t;return(t=A.current)==null?void 0:t.scrollIntoView({behavior:"smooth"})};r.useEffect(P,[o]),r.useEffect(()=>{const t=I(k(N,"chat_rooms"),q("lastMessageAt","desc")),s=L(t,p=>{const y=[];p.forEach(w=>{y.push({id:w.id,...w.data()})}),n(y),M(!1)});return()=>s()},[]),r.useEffect(()=>{if(!a){u({});return}Y(!0);const t=I(k(N,"team_chat_messages"),G("roomId","==",a),q("createdAt")),s=L(t,p=>{const w=p.docs.map(h=>({id:h.id,...h.data()})).reduce((h,z)=>{var T;const S=b((T=z.createdAt)==null?void 0:T.toDate()).format("YYYY-MM-DD");return h[S]||(h[S]=[]),h[S].push(z),h},{});u(w),Y(!1)});return()=>s()},[a]);const B=async t=>{if(t.preventDefault(),!(c.trim()===""||!a||!m||!d))try{await F(k(N,"team_chat_messages"),{roomId:a,text:c.trim(),createdAt:C(),userId:d.id,userName:m.name,userRole:m.role||"Member"});const s=H(N,"chat_rooms",a);await J(s,{lastMessage:c.trim(),lastMessageAt:C()}),x("")}catch(s){console.error("Error sending message: ",s)}},W=t=>b(t).calendar(null,{sameDay:"[Today]",lastDay:"[Yesterday]",lastWeek:"dddd, D MMM",sameElse:"dddd, D MMMM YYYY"});return e.jsxs(e.Fragment,{children:[e.jsx(oe,{isOpen:g,onClose:()=>i(!1)}),e.jsxs("div",{className:"flex h-[calc(100vh-64px)] bg-gray-50 dark:bg-zinc-900 border-t",children:[e.jsxs("aside",{className:"w-1/3 min-w-[300px] max-w-[400px] flex flex-col border-r dark:border-zinc-700 bg-white dark:bg-zinc-800",children:[e.jsxs("div",{className:"p-4 border-b dark:border-zinc-700 flex justify-between items-center",children:[e.jsx("h2",{className:"text-xl font-bold",children:"Chat Rooms"}),e.jsx("button",{onClick:()=>i(!0),className:"p-2 rounded-full hover:bg-gray-100 dark:hover:bg-zinc-700",title:"Start new chat",children:e.jsx(ee,{className:"w-6 h-6 text-primary"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:v?e.jsx("p",{className:"p-4 text-center",children:"Loading rooms..."}):f.map(t=>{var s;return e.jsxs("div",{onClick:()=>l(t.id),className:`p-4 border-b dark:border-zinc-700 cursor-pointer ${a===t.id?"bg-primary-50 dark:bg-primary-900/50":"hover:bg-gray-100 dark:hover:bg-zinc-700/50"}`,children:[e.jsx("h3",{className:"font-semibold text-gray-800 dark:text-white truncate",children:t.topic}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 truncate",children:t.lastMessage}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:b((s=t.lastMessageAt)==null?void 0:s.toDate()).fromNow()})]},t.id)})})]}),e.jsx("main",{className:"flex-1 flex flex-col",children:a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[j?e.jsx("p",{className:"text-center",children:"Loading messages..."}):Object.keys(o).sort().map(t=>e.jsxs("div",{children:[e.jsxs("div",{className:"relative my-5 text-center",children:[e.jsx("hr",{className:"absolute top-1/2 left-0 w-full border-t border-gray-200 dark:border-gray-700"}),e.jsx("span",{className:"relative inline-block px-3 bg-gray-50 dark:bg-zinc-900 text-sm font-medium text-gray-500 rounded-full",children:W(t)})]}),e.jsx("div",{className:"space-y-4",children:o[t].map(s=>{var y;const p=s.userId===(d==null?void 0:d.id);return e.jsx("div",{className:`flex items-end gap-2 ${p?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-md lg:max-w-lg p-3 rounded-2xl ${p?"bg-primary text-primary-foreground rounded-br-lg":"bg-card text-card-foreground rounded-bl-lg"}`,children:[!p&&e.jsxs("p",{className:`text-xs font-bold mb-1 ${s.userRole==="Owner"?"text-red-400":s.userRole==="Manager"?"text-blue-400":"text-green-400"}`,children:[s.userName," (",s.userRole,")"]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.text}),e.jsx("p",{className:"text-xs opacity-70 mt-1 text-right",children:b((y=s.createdAt)==null?void 0:y.toDate()).format("h:mm A")})]})},s.id)})})]},t)),e.jsx("div",{ref:A})]}),e.jsxs("footer",{className:"p-4 bg-background border-t",children:[e.jsxs("form",{onSubmit:B,className:"flex items-center gap-3",children:[e.jsx(O,{id:"message-input",type:"text",value:c,onChange:t=>x(t.target.value),placeholder:"Type a message...",className:"flex-1",autoFocus:!0}),e.jsx(E,{type:"submit",size:"icon",disabled:!c.trim(),children:e.jsx(Z,{className:"w-5 h-5"})})]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2 ml-1",children:["Press ",e.jsx("kbd",{className:"px-2 py-1 text-xs font-semibold text-foreground bg-muted border rounded-md",children:"Enter"})," to send."]})]})]}):e.jsxs("div",{className:"flex-1 flex flex-col justify-center items-center text-center p-4",children:[e.jsx(Q,{className:"w-16 h-16 text-gray-300 dark:text-zinc-600"}),e.jsx("h2",{className:"mt-4 text-xl font-semibold text-gray-700 dark:text-gray-300",children:"Select a room to start chatting"}),e.jsx("p",{className:"text-gray-500",children:"Choose from the list on the left or create a new chat room."})]})})]})]})};export{xe as default};
