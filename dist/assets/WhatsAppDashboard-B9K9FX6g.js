import{r as a,u as T,g as U,s as g,V as v,j as t,a as R,T as G,O as W,M as H,h as z,B as K}from"./index-BQ92t-xb.js";import{C as M}from"./Card-Cr9OAgbB.js";import{S as $}from"./Select-BwRdW-mQ.js";import{T as V}from"./TextArea-Cp0WOQfX.js";import{S as J}from"./send-DvzX1HMZ.js";const Q=({allCustomers:_,templates:h,onRefresh:N,initialOrder:l})=>{const{user:w}=z(),[d,C]=a.useState(""),[y,b]=a.useState(""),[s,j]=a.useState(null),[m,f]=a.useState(""),[x,S]=a.useState([]),[n,u]=a.useState(!1);a.useEffect(()=>{if(l){C(l.customer_id),S([l]),b(String(l.order_id));const e=h.find(o=>o.name.toLowerCase().includes("full invoice details"));e&&j(e)}},[l,h]),a.useEffect(()=>{d&&!l&&(async()=>{u(!0),S([]),b(""),j(null);const{data:o,error:p}=await g.from("all_order_summary").select("*").eq("customer_id",d).order("order_id",{ascending:!1});p?v.error("Failed to fetch orders for customer."):S(o),u(!1)})()},[d,l]),a.useEffect(()=>{let e=!0;return(async()=>{const p=_.find(c=>c.id===d),i=x.find(c=>c.order_id===parseInt(y));if(!s||!i||!p){e&&f("");return}u(!0);const{data:q,error:O}=await g.from("orders").select("quantity, order_type").eq("id",i.order_id).single(),{data:I,error:k}=await g.from("payments").select("payment_date, amount_paid, payment_method").eq("order_id",i.order_id).order("payment_date",{ascending:!0});if(!e)return;if(O||k){console.error("Order Details Error:",O),console.error("Payment History Error:",k),v.error("Failed to fetch full order details."),u(!1);return}const r={...i,...q};let A="இதுவரை பணம் எதுவும் செலுத்தப்படவில்லை";I&&I.length>0&&(A=I.map(c=>`- ₹${c.amount_paid.toLocaleString("en-IN")} via ${c.payment_method} on ${new Date(c.payment_date).toLocaleDateString("en-GB")}`).join(`
`));const B=`${window.location.origin}/invoices/${r.order_id}`,F={customer_name:r.customer_name,order_id:String(r.order_id),order_type:r.order_type,total_amount:r.total_amount.toLocaleString("en-IN"),balance_due:r.balance_due.toLocaleString("en-IN"),delivery_date:r.delivery_date?new Date(r.delivery_date).toLocaleDateString("en-GB"):"N/A",shop_name:"Classic Offset",status:r.status||"Processing",payment_amount:r.amount_paid.toLocaleString("en-IN"),pickup_date:r.delivery_date?new Date(r.delivery_date).toLocaleDateString("en-GB"):"N/A",quantity:String(r.quantity),amount_paid:r.amount_paid.toLocaleString("en-IN"),order_date:r.order_date?new Date(r.order_date).toLocaleDateString("en-GB"):"N/A",invoice_link:B,payment_history:A,customer_phone:r.customer_phone};let E=s.body;Object.entries(F).forEach(([c,P])=>{E=E.replace(new RegExp(`{{${c}}}`,"g"),String(P||""))}),e&&(f(E),u(!1))})(),()=>{e=!1}},[y,s,d,x,_]);const D=async()=>{const e=_.find(i=>i.id===d);if(!(e!=null&&e.phone)||!m)return v.error("Customer phone or message is missing.");const o=e.phone.replace(/\D/g,"");window.open(`https://wa.me/${o}?text=${encodeURIComponent(m)}`,"_blank","noopener,noreferrer");const{error:p}=await g.from("whatsapp_log").insert({customer_id:e.id,customer_name:e.name,phone:e.phone,message:m,template_name:s==null?void 0:s.name,sent_by:w==null?void 0:w.id});p?v.error(`Log failed: ${p.message}`):(v.success("Message sent and logged!"),N())},L=e=>`#${e.order_id} - ${e.order_type} (Due: ₹${e.balance_due.toLocaleString("en-IN")})`;return t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 items-start",children:[t.jsx(M,{title:"Compose Message",children:t.jsxs("div",{className:"p-5 space-y-4",children:[t.jsx($,{id:"customer-select",label:"1. Select Customer",options:_.map(e=>({value:e.id,label:`${e.name} (${e.phone})`})),value:d,onChange:e=>C(e.target.value),placeholder:"Choose a customer"}),t.jsx($,{id:"order-select",label:"2. Select Order",options:x.map(e=>({value:e.order_id,label:L(e)})),value:y,onChange:e=>b(e.target.value),disabled:!d||n,placeholder:n?"Loading orders...":"Choose an order"}),t.jsx($,{id:"template-select",label:"3. Select Template",options:h.map(e=>({value:e.name,label:e.name})),value:(s==null?void 0:s.name)||"",onChange:e=>j(h.find(o=>o.name===e.target.value)||null),disabled:!y,placeholder:"Choose a template"}),t.jsx(V,{id:"message-review",label:"4. Review Message",value:m,onChange:e=>f(e.target.value),rows:12,placeholder:"Message will be generated here...",disabled:n}),t.jsxs(K,{onClick:D,fullWidth:!0,variant:"success",disabled:!m||n,children:[t.jsx(J,{className:"w-4 h-4 mr-2"})," Send on WhatsApp"]})]})}),t.jsx(M,{title:"Message Preview",children:t.jsx("div",{className:"p-5 min-h-[300px] bg-gray-50 dark:bg-gray-800 rounded-b-lg",children:n?t.jsx("div",{className:"flex justify-center items-center h-full",children:t.jsx(R,{className:"animate-spin"})}):t.jsx("pre",{className:"text-sm text-gray-700 dark:text-gray-200 whitespace-pre-wrap font-sans",children:m||"Select customer, order, and template for preview."})})})]})},re=()=>{const[_,h]=a.useState(!0),[N,l]=a.useState(null),[w,d]=a.useState([]),[C,y]=a.useState([]),[b,s]=a.useState(null),[j,m]=a.useState(0),f=T(),x=U(),S=a.useCallback(async()=>{h(!0),l(null);try{const u=new URLSearchParams(f.search).get("orderId"),[D,L,e]=await Promise.all([g.from("customers").select("id, name, phone").order("name"),g.from("whatsapp_templates").select("*").order("name"),g.from("all_order_summary").select("*").gt("balance_due",0)]),o=[D.error,L.error,e.error].filter(Boolean);if(o.length>0)throw o[0];if(d(D.data||[]),y(L.data||[]),u){const{data:p,error:i}=await g.from("all_order_summary").select("*").eq("order_id",u).single();if(i)throw i;s(p),x(f.pathname,{replace:!0})}else s(null)}catch(n){v.error(n.message||"Failed to load dashboard data."),l(n.message)}finally{h(!1)}},[f.search,x]);return a.useEffect(()=>{S()},[S,j]),_?t.jsx("div",{className:"text-center p-8",children:t.jsx(R,{className:"w-8 h-8 animate-spin mx-auto text-primary-500"})}):N?t.jsx(M,{className:"m-4",children:t.jsxs("div",{className:"p-4 bg-red-50 text-red-700 rounded-md",children:[t.jsx(G,{className:"inline w-5 mr-2"})," ",N]})}):t.jsxs("div",{className:"p-4 sm:p-6 space-y-6",children:[t.jsx(W,{position:"top-right"}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(H,{size:28,className:"text-green-500"}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:"WhatsApp Suite"}),t.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Send personalized messages to your customers."})]})]}),t.jsx(Q,{allCustomers:w,templates:C,initialOrder:b,onRefresh:()=>m(n=>n+1)})]})};export{re as default};
